#!/usr/bin/env python
#
#  Copyright (c) 2012, Sean Reifschneider, tummy.com, ltd.
#  All Rights Reserved.

'''
The engine which runs the backup process.  This is called with the name
of a Host() which is to be backed up.
'''

import os
import sys
sys.path.append('lib')              # ZFSBACKUPLIBDIR

import nabsupp
from nabdb import *
db = nabdb.session()


def run_backup_for_host(hostname):
    host = db.query(Host).filter_by(hostname=hostname).first()

    if nabsupp.are_backups_currently_running(db, host):
        sys.stderr.write('ERROR: Backups are already running.  Aborting.\n')
        sys.exit(1)

    if not host.active:
        sys.stderr.write('This host is not enabled for backups '
                '(active=False)\n')
        sys.exit(1)

    backup = Backup()
    backup.setup(host=host, generation=host.find_backup_generation(db),
            full_checksum=host.ready_for_checksum(db))
    backup.backup_pid = os.getpid()
    db.add(backup)
    db.commit()

################################
run_backup_for_host(sys.argv[1])
